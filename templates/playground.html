<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <title>SQL Playground - Interactive SQL Query Editor | ETL Parser</title>
    <meta name="description" content="Free online SQL playground with live query execution, syntax highlighting, and sample data. Test SQL queries, share results, and learn SQL interactively.">
    <meta name="keywords" content="SQL playground, SQL editor online, SQL test, interactive SQL, SQL sandbox, learn SQL, SQL practice">
    
    <!-- CodeMirror CSS -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/codemirror.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/theme/dracula.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/addon/hint/show-hint.min.css">
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Helvetica Neue', sans-serif;
            background: #f8f9fa;
            color: #2c3e50;
            min-height: 100vh;
        }
        
        .navbar {
            background: white;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            padding: 1rem 2rem;
            position: sticky;
            top: 0;
            z-index: 100;
        }
        
        .navbar-content {
            max-width: 1400px;
            margin: 0 auto;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .logo {
            font-size: 1.3em;
            font-weight: 700;
            color: #1a3a52;
            letter-spacing: -0.5px;
        }
        
        .nav-links {
            display: flex;
            gap: 2rem;
            font-size: 0.9em;
        }
        
        .nav-links a {
            text-decoration: none;
            color: #5a6c7d;
            transition: color 0.3s;
        }
        
        .nav-links a:hover {
            color: #1a3a52;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 1.5rem;
        }
        
        .playground-header {
            margin-bottom: 1.5rem;
        }
        
        .playground-header h1 {
            font-size: 1.8em;
            color: #1a3a52;
            margin-bottom: 0.5rem;
        }
        
        .playground-header p {
            color: #5a6c7d;
            font-size: 0.95em;
        }
        
        .playground-layout {
            display: grid;
            grid-template-columns: 250px 1fr 350px;
            gap: 1.5rem;
            height: calc(100vh - 200px);
        }
        
        @media (max-width: 1200px) {
            .playground-layout {
                grid-template-columns: 1fr;
                height: auto;
            }
            
            .sidebar, .results-panel {
                height: auto;
            }
        }
        
        .sidebar {
            background: white;
            border-radius: 8px;
            padding: 1.5rem;
            overflow-y: auto;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }
        
        .sidebar h3 {
            font-size: 1em;
            color: #1a3a52;
            margin-bottom: 1rem;
            font-weight: 600;
        }
        
        .tab-buttons {
            display: flex;
            gap: 0.5rem;
            margin-bottom: 1rem;
            flex-wrap: wrap;
        }
        
        .tab-btn {
            padding: 0.5rem 1rem;
            background: #f0f2f5;
            border: 1px solid #d0d7e0;
            color: #5a6c7d;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.85em;
            transition: all 0.3s;
        }
        
        .tab-btn.active {
            background: #2c5aa0;
            color: white;
            border-color: #2c5aa0;
        }
        
        .tab-content {
            display: none;
        }
        
        .tab-content.active {
            display: block;
        }
        
        .sample-query {
            background: #f8f9fa;
            padding: 0.8rem;
            border-radius: 4px;
            margin-bottom: 0.8rem;
            cursor: pointer;
            border: 1px solid #e0e0e0;
            transition: all 0.3s;
            border: 1px solid transparent;
        }
        
        .sample-query:hover {
            border-color: #2c5aa0;
            background: #f0f4f8;
        }
        
        .sample-query-name {
            font-weight: 600;
            color: #1a3a52;
            font-size: 0.9em;
            margin-bottom: 0.3rem;
        }
        
        .sample-query-desc {
            font-size: 0.8em;
            color: #5a6c7d;
        }
        
        .sample-query-category {
            font-size: 0.75em;
            color: #2c5aa0;
            margin-top: 0.3rem;
            font-weight: 500;
        }
        
        .schema-table {
            margin-bottom: 1rem;
            padding: 0.5rem;
            border-radius: 4px;
            transition: all 0.2s ease;
        }
        
        .schema-table:hover {
            background: #f0f4f8;
            transform: translateX(4px);
        }
        
        .schema-table-name {
            font-weight: 600;
            color: #2c5aa0;
            font-size: 0.9em;
            margin-bottom: 0.5rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .schema-column {
            font-size: 0.85em;
            color: #5a6c7d;
            padding: 0.3rem 0.5rem;
            padding-left: 1.5rem;
        }
        
        .schema-column-type {
            color: #7c3aed;
            font-size: 0.8em;
        }
        
        .editor-panel {
            display: flex;
            flex-direction: column;
            background: white;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }
        
        .editor-toolbar {
            background: #f8f9fa;
            padding: 0.8rem 1rem;
            display: flex;
            gap: 0.8rem;
            border-bottom: 1px solid #e0e0e0;
        }
        
        .btn {
            padding: 0.6rem 1.2rem;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.9em;
            font-weight: 500;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .btn-primary {
            background: #2c5aa0;
            color: white;
        }
        
        .btn-primary:hover {
            background: #1a3a52;
        }
        
        .btn-secondary {
            background: #f0f2f5;
            color: #5a6c7d;
            border: 1px solid #d0d7e0;
        }
        
        .btn-secondary:hover {
            background: #e3e6ea;
        }
        
        .btn-success {
            background: #22c55e;
            color: white;
        }
        
        .btn-success:hover {
            background: #16a34a;
        }
        
        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        .editor-container {
            flex: 1;
            overflow: hidden;
        }
        
        .CodeMirror {
            height: 100% !important;
            font-size: 14px;
            font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace;
        }
        
        .results-panel {
            background: white;
            border-radius: 8px;
            padding: 1.5rem;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }
        
        .results-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }
        
        .results-header h3 {
            font-size: 1em;
            color: #1a3a52;
            font-weight: 600;
        }
        
        .results-stats {
            font-size: 0.85em;
            color: #5a6c7d;
        }
        
        .results-table-container {
            flex: 1;
            overflow: auto;
            background: white;
            border-radius: 4px;
            border: 1px solid #e0e0e0;
        }
        
        .results-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.85em;
        }
        
        .results-table th {
            background: #f8f9fa;
            color: #1a3a52;
            padding: 0.8rem;
            text-align: left;
            position: sticky;
            top: 0;
            font-weight: 600;
            border-bottom: 2px solid #2c5aa0;
        }
        
        .results-table td {
            padding: 0.8rem;
            border-bottom: 1px solid #e0e0e0;
            color: #2c3e50;
        }
        
        .results-table tr:hover {
            background: #f8f9fa;
        }
        
        .error-message {
            background: #fee2e2;
            color: #991b1b;
            padding: 1rem;
            border-radius: 4px;
            margin-top: 1rem;
            font-size: 0.9em;
            border-left: 4px solid #ef4444;
        }
        
        .success-message {
            background: #f0fdf4;
            color: #15803d;
            padding: 1rem;
            border-radius: 4px;
            margin-top: 1rem;
            font-size: 0.9em;
            border-left: 4px solid #22c55e;
        }
        
        .empty-state {
            text-align: center;
            padding: 3rem;
            color: #5a6c7d;
        }
        
        .share-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }
        
        .share-modal.active {
            display: flex;
        }
        
        .share-modal-content {
            background: white;
            padding: 2rem;
            border-radius: 8px;
            max-width: 500px;
            width: 90%;
        }
        
        .share-modal h3 {
            color: #1a3a52;
            margin-bottom: 1rem;
            font-weight: 600;
        }
        
        .share-url-container {
            display: flex;
            gap: 0.5rem;
            margin-bottom: 1rem;
        }
        
        .share-url {
            flex: 1;
            background: #f8f9fa;
            border: 1px solid #d0d7e0;
            padding: 0.8rem;
            border-radius: 4px;
            color: #2c5aa0;
            font-family: monospace;
        }
        
        .loading {
            text-align: center;
            padding: 2rem;
            color: #5a6c7d;
        }
        
        .spinner {
            border: 3px solid #f0f2f5;
            border-top: 3px solid #2c5aa0;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 1rem;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <div class="navbar">
        <div class="navbar-content">
            <div class="logo">SQL Playground</div>
            <div class="nav-links">
                <a href="/">‚Üê Back to ETL Validator</a>
                <a href="#" id="aboutLink">About</a>
            </div>
        </div>
    </div>

    <div class="container">
        <div class="playground-header">
            <h1>Interactive SQL Playground</h1>
            <p>Write SQL queries, test with sample data, and share your results instantly</p>
        </div>

        <div class="playground-layout">
            <!-- Sidebar with samples and schema -->
            <div class="sidebar">
                <h3>ETL Test Library</h3>
                
                <!-- Tab Buttons -->
                <div class="tab-buttons">
                    <button class="tab-btn active" onclick="switchTab('etl-tests')">ETL Tests</button>
                    <button class="tab-btn" onclick="switchTab('data-quality')">Data Quality</button>
                    <button class="tab-btn" onclick="switchTab('profiling')">Profiling</button>
                    <button class="tab-btn" onclick="switchTab('tutorial')">üìö Tutorial</button>
                    <button class="tab-btn" onclick="switchTab('schema')">Schema</button>
                </div>
                
                <!-- ETL Tests Tab -->
                <div id="etl-tests" class="tab-content active">
                    <div id="sampleQueries"></div>
                </div>
                
                <!-- Data Quality Tab -->
                <div id="data-quality" class="tab-content">
                    <div id="qualityQueries"></div>
                </div>
                
                <!-- Profiling Tab -->
                <div id="profiling" class="tab-content">
                    <div id="profilingQueries"></div>
                </div>
                
                <!-- Tutorial Tab -->
                <div id="tutorial" class="tab-content" style="padding: 1rem; overflow-y: auto; max-height: calc(100vh - 350px);">
                    <h4 style="color: #2c5aa0; margin-bottom: 1rem; font-size: 1.1em;">üéØ SQL Quick Reference</h4>
                    
                    <div style="margin-bottom: 1.5rem; padding: 1rem; background: #f0f9ff; border-radius: 6px; border-left: 3px solid #2c5aa0;">
                        <h5 style="margin: 0 0 0.5rem 0; color: #1a3a52; font-size: 0.95em;">SELECT Basics</h5>
                        <pre style="background: #1e1e1e; color: #d4d4d4; padding: 0.75rem; border-radius: 4px; overflow-x: auto; font-size: 0.8em; margin: 0;">-- All columns
SELECT * FROM customers;

-- Specific columns
SELECT customer_id, email
FROM customers
WHERE status = 'ACTIVE';</pre>
                    </div>
                    
                    <div style="margin-bottom: 1.5rem; padding: 1rem; background: #fef3c7; border-radius: 6px; border-left: 3px solid #f59e0b;">
                        <h5 style="margin: 0 0 0.5rem 0; color: #1a3a52; font-size: 0.95em;">JOINs</h5>
                        <pre style="background: #1e1e1e; color: #d4d4d4; padding: 0.75rem; border-radius: 4px; overflow-x: auto; font-size: 0.8em; margin: 0;">-- INNER JOIN
SELECT c.customer_id, o.order_id
FROM customers c
INNER JOIN orders o
  ON c.customer_id = o.customer_id;</pre>
                    </div>
                    
                    <div style="margin-bottom: 1.5rem; padding: 1rem; background: #f0fdf4; border-radius: 6px; border-left: 3px solid #22c55e;">
                        <h5 style="margin: 0 0 0.5rem 0; color: #1a3a52; font-size: 0.95em;">Aggregations</h5>
                        <pre style="background: #1e1e1e; color: #d4d4d4; padding: 0.75rem; border-radius: 4px; overflow-x: auto; font-size: 0.8em; margin: 0;">-- Count & Sum
SELECT 
  COUNT(*) as total,
  SUM(amount) as total_amt
FROM orders
GROUP BY customer_id;</pre>
                    </div>
                    
                    <div style="margin-bottom: 1.5rem; padding: 1rem; background: #fef2f2; border-radius: 6px; border-left: 3px solid #ef4444;">
                        <h5 style="margin: 0 0 0.5rem 0; color: #1a3a52; font-size: 0.95em;">ETL Validation</h5>
                        <pre style="background: #1e1e1e; color: #d4d4d4; padding: 0.75rem; border-radius: 4px; overflow-x: auto; font-size: 0.8em; margin: 0;">-- Find differences
SELECT * FROM source
EXCEPT
SELECT * FROM target;</pre>
                    </div>
                    
                    <div style="margin-bottom: 1.5rem; padding: 1rem; background: #f5f3ff; border-radius: 6px; border-left: 3px solid #7c3aed;">
                        <h5 style="margin: 0 0 0.5rem 0; color: #1a3a52; font-size: 0.95em;">CASE Statement</h5>
                        <pre style="background: #1e1e1e; color: #d4d4d4; padding: 0.75rem; border-radius: 4px; overflow-x: auto; font-size: 0.8em; margin: 0;">-- Conditional logic
SELECT 
  customer_id,
  CASE 
    WHEN status = 'ACTIVE' 
      THEN 'A'
    ELSE 'I'
  END as status_code
FROM customers;</pre>
                    </div>
                    
                    <div style="padding: 1rem; background: #e0f2fe; border-radius: 6px;">
                        <h5 style="margin: 0 0 0.75rem 0; color: #1a3a52; font-size: 0.95em;">üí° Pro Tips</h5>
                        <ul style="margin: 0; padding-left: 1.25rem; color: #5a6c7d; font-size: 0.85em; line-height: 1.6;">
                            <li>Use <code style="background: white; padding: 0.1rem 0.3rem; border-radius: 2px;">WHERE</code> before <code style="background: white; padding: 0.1rem 0.3rem; border-radius: 2px;">GROUP BY</code></li>
                            <li><code style="background: white; padding: 0.1rem 0.3rem; border-radius: 2px;">HAVING</code> filters after grouping</li>
                            <li>Click examples above to try them!</li>
                            <li>Use <code style="background: white; padding: 0.1rem 0.3rem; border-radius: 2px;">LIMIT</code> for large results</li>
                        </ul>
                    </div>
                    
                    <div style="margin-top: 1rem; text-align: center;">
                        <a href="/" style="color: #2c5aa0; text-decoration: none; font-size: 0.85em; font-weight: 500;">
                            üìñ View Full Tutorials ‚Üí
                        </a>
                    </div>
                </div>
                
                <!-- Schema Tab -->
                <div id="schema" class="tab-content">
                    <div id="databaseSchema"></div>
                </div>
            </div>

            <!-- Editor Panel -->
            <div class="editor-panel">
                <div class="editor-toolbar">
                    <button class="btn btn-primary" id="runBtn">
                        ‚ñ∂Ô∏è Run Query
                    </button>
                    <button class="btn btn-secondary" id="clearBtn">
                        Clear
                    </button>
                    <button class="btn btn-success" id="shareBtn">
                        Share
                    </button>
                    <button class="btn btn-secondary" id="profileBtn" title="Profile selected table">
                        Profile Table
                    </button>
                </div>
                <div class="editor-container">
                    <textarea id="sqlEditor">-- ETL Testing Playground
-- Sample tables: customers, orders

-- Test Row Count Validation
SELECT 'Source' as source, COUNT(*) as row_count FROM customers
UNION ALL
SELECT 'Target' as target, COUNT(*) as row_count FROM customers;</textarea>
                </div>
            </div>

            <!-- Results Panel -->
            <div class="results-panel">
                <div class="results-header">
                    <h3>Results</h3>
                    <span class="results-stats" id="resultsStats"></span>
                </div>
                <div class="results-table-container" id="resultsContainer">
                    <div class="empty-state">
                        <p>Run a query to see results</p>
                    </div>
                </div>
                <div id="errorContainer"></div>
            </div>
        </div>
    </div>

    <!-- Share Modal -->
    <div class="share-modal" id="shareModal">
        <div class="share-modal-content">
            <h3>üîó Share Your Query</h3>
            <p style="color: #b0b0b0; margin-bottom: 1rem; font-size: 0.9em;">
                Copy this link to share your query and results
            </p>
            <div class="share-url-container">
                <input type="text" class="share-url" id="shareUrl" readonly>
                <button class="btn btn-primary" id="copyShareBtn">Copy</button>
            </div>
            <button class="btn btn-secondary" id="closeModalBtn" style="width: 100%;">Close</button>
        </div>
    </div>

    <!-- CodeMirror JS -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/codemirror.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/mode/sql/sql.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/addon/hint/show-hint.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/addon/hint/sql-hint.min.js"></script>

    <script>
        // Initialize CodeMirror
        const editor = CodeMirror.fromTextArea(document.getElementById('sqlEditor'), {
            mode: 'text/x-sql',
            theme: 'dracula',
            lineNumbers: true,
            lineWrapping: true,
            autofocus: true,
            extraKeys: {
                'Ctrl-Space': 'autocomplete',
                'Ctrl-Enter': function() { runQuery(); }
            }
        });

        let currentResults = null;

        // Check if this is a shared view
        const sharedData = {{ shared_data | tojson | safe if shared_data else 'null' }};
        if (sharedData) {
            editor.setValue(sharedData.query);
            if (sharedData.results) {
                displayResults(sharedData.results);
            } else {
                // Execute the shared query
                runQuery();
            }
        }

        // Tab switching function
        function switchTab(tabName) {
            // Hide all tabs
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
            });
            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            
            // Show selected tab
            document.getElementById(tabName).classList.add('active');
            event.target.classList.add('active');
        }

        // Load sample queries
        fetch('/playground/samples')
            .then(res => res.json())
            .then(data => {
                const etlContainer = document.getElementById('sampleQueries');
                const qualityContainer = document.getElementById('qualityQueries');
                const profilingContainer = document.getElementById('profilingQueries');
                
                data.samples.forEach(sample => {
                    const div = document.createElement('div');
                    div.className = 'sample-query';
                    div.innerHTML = `
                        <div class="sample-query-name">${sample.name}</div>
                        <div class="sample-query-desc">${sample.description}</div>
                        ${sample.category ? `<div class="sample-query-category">üìã ${sample.category}</div>` : ''}
                    `;
                    div.onclick = () => editor.setValue(sample.query);
                    
                    // Categorize queries
                    if (sample.category === 'ETL Testing') {
                        etlContainer.appendChild(div);
                    } else if (sample.category === 'Data Quality') {
                        qualityContainer.appendChild(div);
                    } else if (sample.category === 'Data Profiling') {
                        profilingContainer.appendChild(div);
                    } else {
                        etlContainer.appendChild(div);
                    }
                });
            });

        // Load database schema
        fetch('/playground/schema')
            .then(res => res.json())
            .then(data => {
                const container = document.getElementById('databaseSchema');
                Object.entries(data.schema).forEach(([tableName, columns]) => {
                    const tableDiv = document.createElement('div');
                    tableDiv.className = 'schema-table';
                    tableDiv.style.cursor = 'pointer';
                    tableDiv.title = 'Click to generate data quality queries';
                    
                    const nameDiv = document.createElement('div');
                    nameDiv.className = 'schema-table-name';
                    nameDiv.innerHTML = `üìã ${tableName}`;
                    tableDiv.appendChild(nameDiv);
                    
                    columns.forEach(col => {
                        const colDiv = document.createElement('div');
                        colDiv.className = 'schema-column';
                        colDiv.innerHTML = `${col.name} <span class="schema-column-type">${col.type}</span>`;
                        tableDiv.appendChild(colDiv);
                    });
                    
                    // Add click handler to generate data quality queries
                    tableDiv.onclick = () => generateDataQualityQuery(tableName, columns);
                    
                    container.appendChild(tableDiv);
                });
            });

        // Generate data quality queries for a table
        function generateDataQualityQuery(tableName, columns) {
            const columnNames = columns.map(col => col.name);
            const numericCols = columns.filter(col => 
                col.type.toLowerCase().includes('int') || 
                col.type.toLowerCase().includes('real') || 
                col.type.toLowerCase().includes('numeric')
            ).map(col => col.name);
            
            // Build comprehensive data quality query
            let query = `-- Data Quality Analysis for ${tableName}\n\n`;
            
            // 1. Row count and basic stats
            query += `-- 1. Basic Statistics\n`;
            query += `SELECT \n    '${tableName}' as table_name,\n`;
            query += `    COUNT(*) as total_rows,\n`;
            query += `    COUNT(DISTINCT ${columnNames[0]}) as unique_${columnNames[0]}\n`;
            query += `FROM ${tableName};\n\n`;
            
            // 2. NULL analysis
            query += `-- 2. NULL Value Analysis\n`;
            query += `SELECT \n`;
            columnNames.slice(0, 5).forEach((col, idx) => {
                if (idx > 0) query += `UNION ALL\nSELECT \n`;
                query += `    '${col}' as column_name,\n`;
                query += `    COUNT(*) as null_count,\n`;
                query += `    ROUND(COUNT(*) * 100.0 / (SELECT COUNT(*) FROM ${tableName}), 2) as null_percentage\n`;
                query += `FROM ${tableName}\n`;
                query += `WHERE ${col} IS NULL`;
                if (idx < Math.min(4, columnNames.length - 1)) query += `\n`;
            });
            query += `;\n\n`;
            
            // 3. Duplicate detection
            query += `-- 3. Duplicate Detection\n`;
            query += `SELECT \n    ${columnNames[0]},\n`;
            query += `    COUNT(*) as duplicate_count\n`;
            query += `FROM ${tableName}\n`;
            query += `GROUP BY ${columnNames[0]}\n`;
            query += `HAVING COUNT(*) > 1\n`;
            query += `ORDER BY duplicate_count DESC\n`;
            query += `LIMIT 10;\n\n`;
            
            // 4. Numeric statistics (if numeric columns exist)
            if (numericCols.length > 0) {
                query += `-- 4. Numeric Column Statistics\n`;
                query += `SELECT \n`;
                numericCols.slice(0, 3).forEach((col, idx) => {
                    query += `    MIN(${col}) as min_${col},\n`;
                    query += `    MAX(${col}) as max_${col},\n`;
                    query += `    ROUND(AVG(${col}), 2) as avg_${col}`;
                    if (idx < Math.min(2, numericCols.length - 1)) query += `,\n`;
                });
                query += `\nFROM ${tableName};`;
            }
            
            editor.setValue(query);
        }

        // Run Query
        document.getElementById('runBtn').onclick = runQuery;
        
        function runQuery() {
            const query = editor.getValue();
            const resultsContainer = document.getElementById('resultsContainer');
            const errorContainer = document.getElementById('errorContainer');
            const runBtn = document.getElementById('runBtn');
            
            if (!query.trim()) {
                showError('Please enter a SQL query');
                return;
            }
            
            // Show loading
            resultsContainer.innerHTML = '<div class="loading"><div class="spinner"></div>Executing query...</div>';
            errorContainer.innerHTML = '';
            runBtn.disabled = true;
            
            fetch('/playground/execute', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ query: query })
            })
            .then(res => res.json())
            .then(data => {
                runBtn.disabled = false;
                if (data.success) {
                    currentResults = data;
                    displayResults(data);
                } else {
                    showError(data.error);
                }
            })
            .catch(err => {
                runBtn.disabled = false;
                showError('Network error: ' + err.message);
            });
        }

        function displayResults(data) {
            const resultsContainer = document.getElementById('resultsContainer');
            const statsElement = document.getElementById('resultsStats');
            const errorContainer = document.getElementById('errorContainer');
            
            errorContainer.innerHTML = '';
            statsElement.textContent = `${data.row_count} rows`;
            
            if (data.rows.length === 0) {
                resultsContainer.innerHTML = '<div class="empty-state"><div class="empty-state-icon">‚úì</div><p>Query executed successfully<br>No rows returned</p></div>';
                return;
            }
            
            let html = '<table class="results-table"><thead><tr>';
            data.columns.forEach(col => {
                html += `<th>${col}</th>`;
            });
            html += '</tr></thead><tbody>';
            
            data.rows.forEach(row => {
                html += '<tr>';
                data.columns.forEach(col => {
                    const value = row[col];
                    html += `<td>${value !== null && value !== undefined ? value : '<span style="color: #808080;">NULL</span>'}</td>`;
                });
                html += '</tr>';
            });
            
            html += '</tbody></table>';
            resultsContainer.innerHTML = html;
        }

        function showError(message) {
            const resultsContainer = document.getElementById('resultsContainer');
            const errorContainer = document.getElementById('errorContainer');
            
            resultsContainer.innerHTML = '<div class="empty-state"><div class="empty-state-icon">‚ùå</div><p>Query failed</p></div>';
            errorContainer.innerHTML = `<div class="error-message">${message}</div>`;
        }

        // Clear Editor
        document.getElementById('clearBtn').onclick = () => {
            editor.setValue('');
            document.getElementById('resultsContainer').innerHTML = '<div class="empty-state"><div class="empty-state-icon">üí≠</div><p>Run a query to see results</p></div>';
            document.getElementById('errorContainer').innerHTML = '';
            document.getElementById('resultsStats').textContent = '';
        };

        // Share Query
        document.getElementById('shareBtn').onclick = () => {
            const query = editor.getValue();
            
            if (!query.trim()) {
                showError('Please enter a SQL query to share');
                return;
            }
            
            fetch('/playground/share', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({
                    query: query,
                    results: currentResults
                })
            })
            .then(res => res.json())
            .then(data => {
                if (data.success) {
                    document.getElementById('shareUrl').value = data.share_url;
                    document.getElementById('shareModal').classList.add('active');
                } else {
                    showError('Failed to create share link: ' + data.error);
                }
            })
            .catch(err => {
                showError('Network error: ' + err.message);
            });
        };

        // Copy share URL
        document.getElementById('copyShareBtn').onclick = () => {
            const shareUrl = document.getElementById('shareUrl');
            shareUrl.select();
            document.execCommand('copy');
            
            const btn = document.getElementById('copyShareBtn');
            btn.textContent = '‚úì Copied!';
            setTimeout(() => {
                btn.textContent = 'Copy';
            }, 2000);
        };

        // Close modal
        document.getElementById('closeModalBtn').onclick = () => {
            document.getElementById('shareModal').classList.remove('active');
        };

        // Close modal on background click
        document.getElementById('shareModal').onclick = (e) => {
            if (e.target.id === 'shareModal') {
                document.getElementById('shareModal').classList.remove('active');
            }
        };
        
        // Profile Table button
        document.getElementById('profileBtn').onclick = () => {
            const tableName = prompt('Enter table name to profile:', 'customers');
            if (!tableName) return;
            
            fetch(`/playground/profile/${tableName}`)
                .then(res => res.json())
                .then(data => {
                    if (data.success) {
                        const profile = data.profile;
                        let report = `-- Data Profile for ${profile.table}\n`;
                        report += `-- Total Rows: ${profile.row_count}\n\n`;
                        
                        Object.entries(profile.columns).forEach(([col, stats]) => {
                            report += `-- Column: ${col}\n`;
                            report += `--   Distinct Values: ${stats.distinct_values}\n`;
                            report += `--   NULL Count: ${stats.null_count} (${stats.null_percentage}%)\n`;
                            report += `--   Completeness: ${stats.completeness}%\n\n`;
                        });
                        
                        editor.setValue(report);
                        
                        // Show summary
                        const errorContainer = document.getElementById('errorContainer');
                        errorContainer.innerHTML = `<div class="success-message">‚úì Profile generated for ${profile.table} (${profile.row_count} rows)</div>`;
                    } else {
                        showError(data.error);
                    }
                })
                .catch(err => {
                    showError('Failed to generate profile: ' + err.message);
                });
        };
        
        // Add copy buttons to tutorial code blocks (client-side only)
        document.addEventListener('DOMContentLoaded', function() {
            const tutorialCodeBlocks = document.querySelectorAll('#tutorial pre');
            
            tutorialCodeBlocks.forEach((block) => {
                // Create wrapper
                const wrapper = document.createElement('div');
                wrapper.style.position = 'relative';
                block.parentNode.insertBefore(wrapper, block);
                wrapper.appendChild(block);
                
                // Create copy button
                const copyBtn = document.createElement('button');
                copyBtn.innerHTML = 'üìã';
                copyBtn.style.cssText = `
                    position: absolute;
                    top: 0.25rem;
                    right: 0.25rem;
                    padding: 0.3rem 0.6rem;
                    background: rgba(255, 255, 255, 0.95);
                    border: 1px solid #d0d7e0;
                    border-radius: 3px;
                    cursor: pointer;
                    font-size: 0.85em;
                    transition: all 0.2s;
                    z-index: 10;
                `;
                
                copyBtn.addEventListener('mouseenter', function() {
                    this.style.background = 'white';
                    this.style.transform = 'scale(1.1)';
                });
                
                copyBtn.addEventListener('mouseleave', function() {
                    this.style.background = 'rgba(255, 255, 255, 0.95)';
                    this.style.transform = 'scale(1)';
                });
                
                copyBtn.addEventListener('click', function(e) {
                    e.stopPropagation();
                    const code = block.textContent;
                    
                    if (navigator.clipboard && navigator.clipboard.writeText) {
                        navigator.clipboard.writeText(code).then(() => {
                            copyBtn.innerHTML = '‚úì';
                            copyBtn.style.background = '#dcfce7';
                            copyBtn.style.color = '#15803d';
                            
                            setTimeout(() => {
                                copyBtn.innerHTML = 'üìã';
                                copyBtn.style.background = 'rgba(255, 255, 255, 0.95)';
                                copyBtn.style.color = 'inherit';
                            }, 1500);
                        });
                    } else {
                        // Fallback
                        const textArea = document.createElement('textarea');
                        textArea.value = code;
                        textArea.style.position = 'fixed';
                        textArea.style.left = '-999999px';
                        document.body.appendChild(textArea);
                        textArea.select();
                        
                        try {
                            document.execCommand('copy');
                            copyBtn.innerHTML = '‚úì';
                            copyBtn.style.background = '#dcfce7';
                            
                            setTimeout(() => {
                                copyBtn.innerHTML = 'üìã';
                                copyBtn.style.background = 'rgba(255, 255, 255, 0.95)';
                            }, 1500);
                        } catch (err) {
                            console.error('Copy failed:', err);
                        } finally {
                            document.body.removeChild(textArea);
                        }
                    }
                });
                
                wrapper.appendChild(copyBtn);
            });
            
            // Make code blocks clickable to copy to editor
            tutorialCodeBlocks.forEach((block) => {
                block.style.cursor = 'pointer';
                block.title = 'Click to load in editor';
                
                block.addEventListener('click', function() {
                    const code = this.textContent.trim();
                    if (typeof editor !== 'undefined' && editor) {
                        editor.setValue(code);
                        // Scroll to editor
                        document.querySelector('.editor-container').scrollIntoView({
                            behavior: 'smooth',
                            block: 'start'
                        });
                        // Show feedback
                        const errorContainer = document.getElementById('errorContainer');
                        if (errorContainer) {
                            errorContainer.innerHTML = '<div class="success-message">‚úì Query loaded in editor - Click Run to execute!</div>';
                            setTimeout(() => {
                                errorContainer.innerHTML = '';
                            }, 3000);
                        }
                    }
                });
            });
        });
    </script>
</body>
</html>
