<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <title>ETL Mapping Validator - Free Online SQL Validation Tool</title>
    <meta name="description" content="Free ETL mapping validator and SQL generator. Upload CSV mapping files, validate data transformations, and generate SQL queries instantly. Perfect for data engineers and ETL developers.">
    <meta name="keywords" content="ETL validator, SQL generator, data mapping, ETL tool, CSV to SQL, data validation, ETL mapping, free ETL tool">
    <meta name="author" content="ETL Parser">
    <meta name="robots" content="index, follow">
    <link rel="canonical" href="https://etl-parser.onrender.com">
    <!-- Google tag (gtag.js) -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-XFM14SJHV2"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());

      gtag('config', 'G-XFM14SJHV2');
    </script>
    <!-- Iubenda Consent Banner -->
    <script type="text/javascript">
    var _iub = _iub || [];
    _iub.csConfiguration = {"siteId":4404390,"cookiePolicyId":59009062,"lang":"en","storage":{"useSiteId":true}};
    </script>
    <script type="text/javascript" src="https://cs.iubenda.com/autoblocking/4404390.js"></script>
    <script type="text/javascript" src="//cdn.iubenda.com/cs/gpp/stub.js"></script>
    <script type="text/javascript" src="//cdn.iubenda.com/cs/iubenda_cs.js" charset="UTF-8" async></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Helvetica Neue', sans-serif;
            background: #f8f9fa;
            min-height: 100vh;
            color: #2c3e50;
        }
        
        .navbar {
            background: white;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            padding: 1rem 2rem;
            position: sticky;
            top: 0;
            z-index: 100;
        }
        
        .navbar-content {
            max-width: 1200px;
            margin: 0 auto;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .logo {
            font-size: 1.3em;
            font-weight: 700;
            color: #1a3a52;
            letter-spacing: -0.5px;
        }
        
        .nav-links {
            display: flex;
            gap: 2rem;
            font-size: 0.9em;
            color: #5a6c7d;
        }
        
        .nav-links a,
        .nav-links button {
            text-decoration: none;
            color: #5a6c7d;
            transition: color 0.3s;
            background: none;
            border: none;
            cursor: pointer;
            font-size: inherit;
            font-family: inherit;
            padding: 0;
        }
        
        .nav-links a:hover,
        .nav-links button:hover {
            color: #1a3a52;
        }
        
        .nav-links .playground-link {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 0.5rem 1rem;
            border-radius: 4px;
            font-weight: 600;
        }
        
        .nav-links .playground-link:hover {
            background: linear-gradient(135deg, #764ba2 0%, #667eea 100%);
            color: white;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 2rem;
        }
        
        .hero {
            background: linear-gradient(135deg, #1a3a52 0%, #2c5aa0 100%);
            color: white;
            padding: 4rem 2rem;
            border-radius: 8px;
            margin-bottom: 3rem;
            text-align: center;
        }
        
        .hero h1 {
            font-size: 2.2em;
            margin-bottom: 1rem;
            font-weight: 700;
            letter-spacing: -0.5px;
        }
        
        .hero p {
            font-size: 1.1em;
            opacity: 0.9;
            max-width: 600px;
            margin: 0 auto;
            line-height: 1.6;
        }
        
        .content {
            display: grid;
            grid-template-columns: 1fr;
            gap: 2rem;
        }
        
        @media (max-width: 1024px) {
            .content {
                grid-template-columns: 1fr;
            }
        }
        
        .main-card {
            background: white;
            border-radius: 8px;
            padding: 2rem;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }
        
        .sidebar-card {
            background: white;
            border-radius: 8px;
            padding: 1.5rem;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            height: fit-content;
        }
        
        .form-section {
            margin-bottom: 2rem;
        }
        
        .form-section h2 {
            font-size: 1.1em;
            font-weight: 600;
            color: #1a3a52;
            margin-bottom: 1rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .form-group {
            margin-bottom: 1.5rem;
        }
        
        label {
            display: block;
            font-weight: 500;
            margin-bottom: 0.5rem;
            color: #2c3e50;
            font-size: 0.95em;
        }
        
        input[type="text"],
        input[type="file"],
        select,
        textarea {
            width: 100%;
            padding: 0.75rem;
            border: 1px solid #d0d7e0;
            border-radius: 4px;
            font-size: 0.95em;
            font-family: inherit;
            transition: border-color 0.3s, box-shadow 0.3s;
            background: white;
        }
        
        input[type="text"]:focus,
        select:focus,
        textarea:focus {
            outline: none;
            border-color: #2c5aa0;
            box-shadow: 0 0 0 3px rgba(44, 90, 160, 0.1);
        }
        
        .file-upload {
            border: 2px dashed #d0d7e0;
            border-radius: 6px;
            padding: 2rem;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
            background: #f8f9fa;
        }
        
        .file-upload:hover {
            background-color: #f0f2f5;
            border-color: #2c5aa0;
        }
        
        .file-upload.active {
            background-color: #e3eef9;
            border-color: #2c5aa0;
        }
        
        .file-upload input[type="file"] {
            display: none;
        }
        
        .file-upload-label {
            cursor: pointer;
            color: #2c5aa0;
            font-weight: 500;
            display: block;
            width: 100%;
        }
        
        .file-name {
            margin-top: 0.75rem;
            color: #5a6c7d;
            font-size: 0.9em;
            font-style: italic;
        }
        
        .btn {
            background: #2c5aa0;
            color: white;
            padding: 0.75rem 1.5rem;
            border: none;
            border-radius: 4px;
            font-size: 0.95em;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s;
            display: inline-block;
        }
        
        .btn:hover {
            background: #1a3a52;
            box-shadow: 0 4px 12px rgba(44, 90, 160, 0.15);
            transform: translateY(-1px);
        }
        
        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }
        
        .btn-secondary {
            background: #5a6c7d;
        }
        
        .btn-secondary:hover {
            background: #3f4a57;
        }
        
        .btn-accent {
            background: #00a2e8;
        }
        
        .btn-accent:hover {
            background: #0088c4;
        }
        
        .button-group {
            display: flex;
            gap: 1rem;
            margin-top: 1.5rem;
            flex-wrap: wrap;
        }
        
        .results {
            margin-top: 2rem;
            display: none;
            animation: fadeIn 0.4s ease-in-out;
        }
        
        .results.show {
            display: block;
        }
        
        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        .summary {
            background: #f0f4f8;
            padding: 1.5rem;
            border-radius: 6px;
            margin-bottom: 2rem;
            border-left: 4px solid #2c5aa0;
        }
        
        .summary h3 {
            color: #1a3a52;
            margin-bottom: 1rem;
            font-size: 1.1em;
        }
        
        .summary-item {
            margin-bottom: 0.75rem;
            padding: 0.75rem;
            background: white;
            border-radius: 3px;
            border-left: 2px solid #d0d7e0;
            font-size: 0.95em;
        }
        
        .summary-item strong {
            color: #1a3a52;
        }
        
        .query-section {
            background: white;
            padding: 1.5rem;
            border-radius: 6px;
            margin-bottom: 2rem;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }
        
        .query-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }
        
        .query-header h3 {
            color: #1a3a52;
            font-size: 1em;
        }
        
        .copy-btn {
            background: #00a2e8;
            color: white;
            padding: 0.5rem 1rem;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.85em;
            transition: all 0.3s;
        }
        
        .copy-btn:hover {
            background: #0088c4;
        }
        
        .query-box {
            background: #1e1e1e;
            color: #d4d4d4;
            padding: 1.5rem;
            border-radius: 4px;
            overflow-x: auto;
            font-family: 'Courier New', monospace;
            font-size: 0.85em;
            line-height: 1.6;
            white-space: pre;
            border: 1px solid #333;
        }
        
        .error {
            background: #fef2f2;
            color: #b42318;
            padding: 1rem;
            border-radius: 4px;
            margin-top: 1rem;
            display: none;
            border-left: 4px solid #dc2626;
            font-size: 0.95em;
            line-height: 1.6;
        }
        
        .error.show {
            display: block;
        }
        
        .error strong {
            color: #7f1d1d;
            display: block;
            margin-bottom: 0.5rem;
        }
        
        .error p {
            margin: 0.5rem 0;
        }
        
        .error code {
            background: #fee2e2;
            padding: 0.2rem 0.4rem;
            border-radius: 2px;
            font-family: monospace;
            font-size: 0.9em;
        }
        
        .success {
            background: #f0fdf4;
            color: #15803d;
            padding: 1rem;
            border-radius: 4px;
            margin-top: 1rem;
            display: none;
            border-left: 4px solid #22c55e;
        }
        
        .success.show {
            display: block;
        }
        
        .loading {
            text-align: center;
            padding: 2rem;
            display: none;
        }
        
        .loading.show {
            display: block;
        }
        
        .spinner {
            border: 3px solid #f0f2f5;
            border-top: 3px solid #2c5aa0;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 1rem;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .grid-2 {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1.5rem;
        }
        
        @media (max-width: 768px) {
            .grid-2 {
                grid-template-columns: 1fr;
            }
            
            .hero h1 {
                font-size: 1.8em;
            }
            
            .nav-links {
                display: none;
            }
        }
        
        .badge {
            display: inline-block;
            background: #e3eef9;
            color: #2c5aa0;
            padding: 0.25rem 0.75rem;
            border-radius: 12px;
            font-size: 0.8em;
            font-weight: 500;
        }
        
        .ai-analysis {
            background: linear-gradient(135deg, #f0f4f8 0%, #e3eef9 100%);
            padding: 1.5rem;
            border-radius: 6px;
            margin-bottom: 2rem;
            border-left: 4px solid #00a2e8;
        }
        
        .ai-analysis h3 {
            color: #2c5aa0;
            margin-bottom: 1rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .feature-list {
            list-style: none;
            padding: 0;
        }
        
        .feature-list li {
            padding: 0.5rem 0;
            color: #5a6c7d;
            font-size: 0.9em;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .feature-list li:before {
            content: "‚úì";
            color: #00a2e8;
            font-weight: bold;
        }
        
        .contact-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }
        
        .contact-modal.show {
            display: flex;
        }
        
        .contact-content {
            background: white;
            padding: 2rem;
            border-radius: 8px;
            max-width: 600px;
            width: 90%;
        }
        
        .contact-content h2 {
            color: #1a3a52;
            margin-bottom: 1.5rem;
        }
        
        .contact-item {
            margin-bottom: 1.5rem;
            padding: 1rem;
            background: #f8f9fa;
            border-radius: 6px;
            border-left: 4px solid #2c5aa0;
        }
        
        .contact-item h3 {
            color: #2c5aa0;
            margin-bottom: 0.5rem;
            font-size: 0.95em;
        }
        
        .contact-item p {
            color: #5a6c7d;
            margin: 0;
        }
        
        .contact-item a {
            color: #2c5aa0;
            text-decoration: none;
        }
        
        .contact-item a:hover {
            text-decoration: underline;
        }
    </style>
</head>
<body>
    <div class="navbar">
        <div class="navbar-content">
            <div class="logo">ETL Mapping to SQL Query</div>
            <div class="nav-links">
                <a href="/playground/" class="playground-link">üéÆ SQL Playground</a>
                <a href="#features">Features</a>
                <a href="#documentation">Documentation</a>
                <button onclick="showContactModal()">Contact Us</button>
            </div>
        </div>
    </div>
    
    <div class="container">
        <div class="hero">
            <h1>ETL Mapping Validator</h1>
            <p>Convert your ETL mapping documents into validation queries instantly. Validate data transformations, ensure quality, and generate production-ready SQL.</p>
        </div>
        
        <div class="content">
            <div class="main-card">
                <form id="uploadForm">
                <div class="form-section">
                    <h2>Upload Mapping Document</h2>
                    <div class="form-group">
                        <div class="file-upload" id="fileUploadArea">
                            <label for="fileInput" class="file-upload-label">
                                <div style="font-weight: 600; margin-bottom: 0.25rem;">Click to upload or drag and drop</div>
                                <div style="font-size: 0.9em; color: #5a6c7d;">CSV or Excel files (XLS, XLSX)</div>
                            </label>
                            <input type="file" id="fileInput" name="file" accept=".csv,.xlsx,.xls" required>
                            <div class="file-name" id="fileName"></div>
                        </div>
                    </div>
                </div>
                
                <div class="form-section">
                    <h2>Configuration</h2>
                    <div class="grid-2">
                        <div class="form-group">
                            <label for="targetTable">Target Table Name</label>
                            <input type="text" id="targetTable" name="target_table" value="target_table" required>
                        </div>
                        
                        <div class="form-group">
                            <label for="sourceSchema">Source Schema <span class="badge">Optional</span></label>
                            <input type="text" id="sourceSchema" name="source_schema" placeholder="e.g., source_db">
                        </div>
                        
                        <div class="form-group">
                            <label for="targetSchema">Target Schema <span class="badge">Optional</span></label>
                            <input type="text" id="targetSchema" name="target_schema" placeholder="e.g., target_db">
                        </div>
                        
                        <div class="form-group">
                            <label for="databaseType">Database Type</label>
                            <select id="databaseType" name="database_type">
                                <option value="generic">Generic SQL</option>
                                <option value="postgres">PostgreSQL</option>
                                <option value="mysql">MySQL</option>
                                <option value="oracle">Oracle</option>
                                <option value="sqlserver">SQL Server</option>
                                <option value="snowflake">Snowflake</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label for="queryType">Query Type</label>
                        <select id="queryType" name="query_type">
                            <option value="both">Both (Source ‚Üî Target)</option>
                            <option value="source_minus_target">Source MINUS Target</option>
                            <option value="target_minus_source">Target MINUS Source</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label style="display: flex; align-items: center; cursor: pointer; font-weight: 500;">
                            <input type="checkbox" id="useAI" name="use_ai" style="width: auto; margin-right: 0.75rem;">
                            <span>Enable AI Optimization & Analysis</span>
                        </label>
                        <small style="color: #5a6c7d; margin-top: 0.5rem; display: block; margin-left: 1.75rem;">
                            AI-powered query optimization and transformation suggestions (requires API key)
                        </small>
                    </div>
                </div>
                
                <button type="submit" class="btn" id="submitBtn" style="width: 100%; padding: 0.875rem;">Generate SQL Queries</button>
                
                <div class="button-group" style="width: 100%;">
                    <button type="button" class="btn btn-accent" onclick="showAISuggestion()" style="flex: 1;">
                        AI Suggestions
                    </button>
                    <button type="button" class="btn btn-secondary" onclick="showNLMapping()" style="flex: 1;">
                        Natural Language to CSV
                    </button>
                </div>
            </form>
                
                <div class="loading" id="loading">
                    <div class="spinner"></div>
                    <p>Processing your mapping document...</p>
                </div>
                
                <div class="error" id="error"></div>
                
                <div class="results" id="results">
                    <div class="summary" id="summary"></div>
                    <div id="aiAnalysis" style="display: none;"></div>
                    
                    <!-- Test Case Generation Section -->
                    <div id="testCaseSection" style="width: 100%; max-width: 100%; box-sizing: border-box; max-height: 0; overflow: hidden; opacity: 0; margin-bottom: 0; padding: 0 1.5rem; background: linear-gradient(135deg, #f8f9fa 0%, #e8f4f8 100%); border-radius: 8px; border: 2px solid #00a2e8; transition: max-height 0.4s ease-in-out, opacity 0.3s ease-in-out, padding 0.3s ease-in-out, margin-bottom 0.3s ease-in-out;">
                        <h3 style="color: #1a3a52; margin-bottom: 1rem; display: flex; align-items: center; gap: 0.5rem;">
                            <span>üß™</span> Generate Test Cases
                        </h3>
                        <p style="color: #5a6c7d; margin-bottom: 1.5rem; line-height: 1.6;">
                            Create comprehensive test cases covering positive and negative scenarios for your ETL mapping. Export in your preferred test management tool format.
                        </p>
                        
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-bottom: 1.5rem;">
                            <div class="form-group" style="margin: 0;">
                                <label for="testType" style="font-weight: 600; color: #2c3e50; display: block; margin-bottom: 0.5rem;">Test Type</label>
                                <select id="testType" style="width: 100%; padding: 0.75rem; border: 1px solid #d0d7e0; border-radius: 4px; font-size: 1em;">
                                    <option value="all">All Test Cases</option>
                                    <option value="positive">Positive Test Cases Only</option>
                                    <option value="negative">Negative Test Cases Only</option>
                                </select>
                            </div>
                            
                            <div class="form-group" style="margin: 0;">
                                <label for="testFormat" style="font-weight: 600; color: #2c3e50; display: block; margin-bottom: 0.5rem;">Export Format</label>
                                <select id="testFormat" style="width: 100%; padding: 0.75rem; border: 1px solid #d0d7e0; border-radius: 4px; font-size: 1em;">
                                    <option value="qtest">qTest (CSV)</option>
                                    <option value="zephyr">Zephyr (CSV)</option>
                                    <option value="testrail">TestRail (CSV)</option>
                                    <option value="ado">Azure DevOps / ADO (CSV)</option>
                                    <option value="json">JSON Format</option>
                                </select>
                            </div>
                        </div>
                        
                        <div style="display: flex; gap: 1rem;">
                            <button onclick="previewTestCases()" class="btn btn-secondary" style="flex: 1;">
                                üëÅÔ∏è Preview Test Cases
                            </button>
                            <button onclick="downloadTestCases()" class="btn" style="flex: 1; background: linear-gradient(135deg, #00a2e8 0%, #0077b6 100%);">
                                üì• Download Test Cases
                            </button>
                        </div>
                        
                        <!-- Preview Section -->
                        <div id="testCasePreview" style="display: none; margin-top: 1.5rem; padding: 1.5rem; background: white; border-radius: 6px; border: 1px solid #d0d7e0; max-height: 500px; overflow-y: auto;">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                                <h4 style="color: #1a3a52; margin: 0;">Test Case Preview</h4>
                                <button onclick="closeTestCasePreview()" style="background: none; border: none; color: #5a6c7d; cursor: pointer; font-size: 1.2em;">‚úï</button>
                            </div>
                            <div id="testCasePreviewContent"></div>
                        </div>
                    </div>
                    
                    <!-- SQL Queries Section -->
                    <div id="queries"></div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- AI Suggestion Modal -->
    <div id="aiModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000;">
        <div style="background: white; max-width: 600px; margin: 50px auto; padding: 2rem; border-radius: 8px; max-height: 80vh; overflow-y: auto;">
            <h2 style="color: #1a3a52; margin-bottom: 1.5rem;">AI Transformation Suggestion</h2>
            <div style="margin: 1.5rem 0;">
                <label style="display: block; font-weight: 500; margin-bottom: 0.5rem; color: #2c3e50;">Source Column:</label>
                <input type="text" id="aiSourceCol" style="width: 100%; padding: 0.75rem; margin-bottom: 1rem; border: 1px solid #d0d7e0; border-radius: 4px;">
                
                <label style="display: block; font-weight: 500; margin-bottom: 0.5rem; color: #2c3e50;">Target Column:</label>
                <input type="text" id="aiTargetCol" style="width: 100%; padding: 0.75rem; margin-bottom: 1rem; border: 1px solid #d0d7e0; border-radius: 4px;">
                
                <label style="display: block; font-weight: 500; margin-bottom: 0.5rem; color: #2c3e50;">Source Type (optional):</label>
                <input type="text" id="aiSourceType" placeholder="e.g., VARCHAR" style="width: 100%; padding: 0.75rem; margin-bottom: 1rem; border: 1px solid #d0d7e0; border-radius: 4px;">
                
                <label style="display: block; font-weight: 500; margin-bottom: 0.5rem; color: #2c3e50;">Target Type (optional):</label>
                <input type="text" id="aiTargetType" placeholder="e.g., DATE" style="width: 100%; padding: 0.75rem; margin-bottom: 1.5rem; border: 1px solid #d0d7e0; border-radius: 4px;">
            </div>
            <div style="text-align: right; display: flex; gap: 1rem;">
                <button onclick="closeAIModal()" style="padding: 0.75rem 1.5rem; border: 1px solid #d0d7e0; border-radius: 4px; background: white; cursor: pointer; color: #2c3e50;">Cancel</button>
                <button onclick="getAISuggestion()" class="btn">Get Suggestion</button>
            </div>
            <div id="aiSuggestionResult" style="margin-top: 1.5rem;"></div>
        </div>
    </div>
    
    <!-- NL Mapping Modal -->
    <div id="nlModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000;">
        <div style="background: white; max-width: 700px; margin: 50px auto; padding: 2rem; border-radius: 8px; max-height: 80vh; overflow-y: auto;">
            <h2 style="color: #1a3a52; margin-bottom: 1rem;">Generate Mapping from Description</h2>
            <p style="color: #5a6c7d; margin-bottom: 1.5rem; line-height: 1.6;">
                Describe your ETL mapping in plain English, and AI will generate the CSV mapping for you.
            </p>
            <div style="margin: 1.5rem 0;">
                <label style="display: block; font-weight: 500; margin-bottom: 0.5rem; color: #2c3e50;">Description:</label>
                <textarea id="nlDescription" rows="6" style="width: 100%; padding: 0.75rem; margin-bottom: 1.5rem; border: 1px solid #d0d7e0; border-radius: 4px; font-family: inherit;" 
                    placeholder="Example: Map customer ID directly as a key, combine first and last name into full_name, convert email to lowercase, extract year from order_date"></textarea>
            </div>
            <div style="text-align: right; display: flex; gap: 1rem;">
                <button onclick="closeNLModal()" style="padding: 0.75rem 1.5rem; border: 1px solid #d0d7e0; border-radius: 4px; background: white; cursor: pointer; color: #2c3e50;">Cancel</button>
                <button onclick="generateFromNL()" class="btn">Generate Mapping</button>
            </div>
            <div id="nlMappingResult" style="margin-top: 1.5rem;"></div>
        </div>
    </div>
    
    <!-- Format Guide Modal -->
    <div id="formatGuideModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; overflow-y: auto;">
        <div style="background: white; max-width: 800px; margin: 30px auto; padding: 2rem; border-radius: 8px;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
                <h2 style="color: #1a3a52; margin: 0;">Mapping File Format Guide</h2>
                <button onclick="closeFormatGuide()" style="background: none; border: none; font-size: 1.5rem; cursor: pointer; color: #5a6c7d;">‚úï</button>
            </div>
            
            <div style="background: #f0f4f8; padding: 1.5rem; border-radius: 6px; margin-bottom: 1.5rem;">
                <h3 style="color: #2c5aa0; margin-top: 0; margin-bottom: 1rem;">Required Columns</h3>
                <p style="color: #2c3e50; margin: 0.5rem 0;">Your mapping file MUST contain exactly 3 required columns:</p>
                <table style="width: 100%; margin-top: 1rem; border-collapse: collapse;">
                    <tr style="background: #2c5aa0; color: white;">
                        <th style="padding: 0.75rem; text-align: left; border: 1px solid #d0d7e0;">Column Name</th>
                        <th style="padding: 0.75rem; text-align: left; border: 1px solid #d0d7e0;">Description</th>
                        <th style="padding: 0.75rem; text-align: left; border: 1px solid #d0d7e0;">Example</th>
                    </tr>
                    <tr style="background: white; border: 1px solid #d0d7e0;">
                        <td style="padding: 0.75rem; border: 1px solid #d0d7e0;"><code style="background: #f0f4f8; padding: 0.25rem 0.5rem;">source_column</code></td>
                        <td style="padding: 0.75rem; border: 1px solid #d0d7e0;">Source table column name</td>
                        <td style="padding: 0.75rem; border: 1px solid #d0d7e0;"><code>customer_id</code></td>
                    </tr>
                    <tr style="background: #f8f9fa; border: 1px solid #d0d7e0;">
                        <td style="padding: 0.75rem; border: 1px solid #d0d7e0;"><code style="background: #f0f4f8; padding: 0.25rem 0.5rem;">target_column</code></td>
                        <td style="padding: 0.75rem; border: 1px solid #d0d7e0;">Target table column name</td>
                        <td style="padding: 0.75rem; border: 1px solid #d0d7e0;"><code>cust_id</code></td>
                    </tr>
                    <tr style="background: white; border: 1px solid #d0d7e0;">
                        <td style="padding: 0.75rem; border: 1px solid #d0d7e0;"><code style="background: #f0f4f8; padding: 0.25rem 0.5rem;">transformation</code></td>
                        <td style="padding: 0.75rem; border: 1px solid #d0d7e0;">SQL transformation logic</td>
                        <td style="padding: 0.75rem; border: 1px solid #d0d7e0;"><code>source.customer_id</code></td>
                    </tr>
                </table>
            </div>
            
            <div style="background: #f8f9fa; padding: 1.5rem; border-radius: 6px; margin-bottom: 1.5rem;">
                <h3 style="color: #1a3a52; margin-top: 0; margin-bottom: 1rem;">Example CSV Format</h3>
                <pre style="background: white; border: 1px solid #d0d7e0; padding: 1rem; border-radius: 4px; overflow-x: auto; font-size: 0.85em;">source_column,target_column,transformation
customer_id,cust_id,source.customer_id
first_name,fname,source.first_name
email,email_addr,LOWER(source.email)
created_date,created_at,CAST(source.created_date AS DATE)
status,order_status,CASE WHEN source.status = 'ACTIVE' THEN 'A' ELSE 'I' END</pre>
            </div>
            
            <div style="background: #fef3c7; padding: 1rem; border-radius: 6px; border-left: 4px solid #f59e0b; margin-bottom: 1.5rem;">
                <p style="margin: 0; color: #92400e;"><strong>Important:</strong> All required columns must have values for each row. Empty cells in any required column will cause validation errors.</p>
            </div>
            
            <div style="text-align: right;">
                <button onclick="closeFormatGuide()" class="btn">Got it!</button>
            </div>
        </div>
    </div>
    
    <!-- Contact Us Modal -->
    <div id="contactModal" class="contact-modal">
        <div class="contact-content">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
                <h2 style="margin: 0;">Contact Us</h2>
                <button onclick="closeContactModal()" style="background: none; border: none; font-size: 1.5rem; cursor: pointer; color: #5a6c7d;">‚úï</button>
            </div>
            
            <p style="color: #5a6c7d; margin-bottom: 1.5rem;">Have questions, found a bug, or want to share feedback? We'd love to hear from you!</p>
            
            <div class="contact-item">
                <h3>Email</h3>
                <p><a href="mailto:hkrishnan62@gmail.com">hkrishnan62@gmail.com</a></p>
            </div>
            
            <div class="contact-item">
                <h3>GitHub Issues</h3>
                <p>Report bugs or suggest features on <a href="https://github.com/hkrishnan62/ETL_Parser/issues" target="_blank">our GitHub repository</a></p>
            </div>
            
            <div class="contact-item">
                <h3>Feedback & Suggestions</h3>
                <p>Email us your ideas or suggestions at <a href="mailto:hkrishnan62@gmail.com">hkrishnan62@gmail.com</a></p>
            </div>
            
            <div style="text-align: right; margin-top: 2rem;">
                <button onclick="closeContactModal()" class="btn">Close</button>
            </div>
        </div>
    </div>
    
    <script>
        // File input handling
        const fileInput = document.getElementById('fileInput');
        const fileName = document.getElementById('fileName');
        const fileUploadArea = document.getElementById('fileUploadArea');
        
        // File selection handler
        fileInput.addEventListener('change', function(e) {
            if (e.target.files && e.target.files.length > 0) {
                const file = e.target.files[0];
                fileName.textContent = '‚úì Selected: ' + file.name + ' (' + (file.size / 1024).toFixed(2) + ' KB)';
                fileName.style.color = '#22c55e';
                fileName.style.fontWeight = 'bold';
                fileUploadArea.classList.add('active');
                console.log('‚úì File selected:', file.name, 'Type:', file.type, 'Size:', file.size);
            } else {
                fileName.textContent = '';
                fileUploadArea.classList.remove('active');
            }
        });
        
        // Drag and drop functionality
        ['dragover', 'dragenter'].forEach(eventName => {
            fileUploadArea.addEventListener(eventName, function(e) {
                e.preventDefault();
                e.stopPropagation();
                this.style.backgroundColor = '#e3eef9';
                this.style.borderColor = '#2c5aa0';
            });
        });
        
        ['dragleave', 'dragend'].forEach(eventName => {
            fileUploadArea.addEventListener(eventName, function(e) {
                e.preventDefault();
                e.stopPropagation();
                this.style.backgroundColor = '';
                this.style.borderColor = '#d0d7e0';
            });
        });
        
        fileUploadArea.addEventListener('drop', function(e) {
            e.preventDefault();
            e.stopPropagation();
            this.style.backgroundColor = '';
            this.style.borderColor = '#d0d7e0';
            
            const files = e.dataTransfer.files;
            if (files && files.length > 0) {
                fileInput.files = files;
                // Trigger change event manually
                fileInput.dispatchEvent(new Event('change', { bubbles: true }));
                console.log('‚úì File dropped:', files[0].name);
            }
        });
        
        // Form submission
        document.getElementById('uploadForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            // Validate file is selected
            if (!fileInput.files || fileInput.files.length === 0) {
                alert('Please select a file to upload');
                return;
            }
            
            const file = fileInput.files[0];
            const fileExt = file.name.split('.').pop().toLowerCase();
            
            // Validate file extension
            if (!['csv', 'xlsx', 'xls'].includes(fileExt)) {
                alert('Please upload a CSV or Excel file (.csv, .xlsx, .xls)');
                return;
            }
            
            // Validate file size (16MB limit)
            if (file.size > 16 * 1024 * 1024) {
                alert('File size must be less than 16MB');
                return;
            }
            
            const formData = new FormData(this);
            
            // Ensure file is in FormData (some browsers need explicit add)
            if (fileInput.files[0]) {
                formData.set('file', fileInput.files[0]);
            }
            
            const useAI = document.getElementById('useAI').checked;
            formData.append('use_ai', useAI);
            
            // Debug: Log FormData contents
            console.log('=== Upload Debug Info ===');
            console.log('File:', file.name, 'Size:', file.size, 'Type:', file.type);
            console.log('Target Table:', formData.get('target_table'));
            console.log('Use AI:', formData.get('use_ai'));
            console.log('File in FormData:', formData.get('file') ? 'Yes' : 'No');
            console.log('========================');
            
            const loading = document.getElementById('loading');
            const results = document.getElementById('results');
            const error = document.getElementById('error');
            const submitBtn = document.getElementById('submitBtn');
            
            // Show loading, hide results and errors
            loading.classList.add('show');
            results.classList.remove('show');
            error.classList.remove('show');
            submitBtn.disabled = true;
            
            try {
                console.log('Sending request to /upload...');
                const response = await fetch('/upload', {
                    method: 'POST',
                    body: formData
                });
                
                console.log('Response received:', response.status, response.statusText);
                
                if (!response.ok) {
                    const errorText = await response.text();
                    console.error('Server error response:', errorText);
                    throw new Error('Server error: ' + response.status + ' - ' + errorText);
                }
                
                const data = await response.json();
                console.log('Response data:', data);
                
                if (data.error) {
                    console.error('API error:', data.error);
                    throw new Error(data.error);
                }
                
                console.log('‚úì Upload successful!');
                
                // Store mapping data for test case generation
                window.currentMappingData = {
                    mappings: data.summary.mappings || [],
                    summary: data.summary
                };
                
                // Display results
                displaySummary(data.summary);
                
                // Display AI analysis if available
                if (data.ai_analysis && data.ai_analysis.ai_available) {
                    displayAIAnalysis(data.ai_analysis);
                }
                
                displayQueries(data.queries);
                
                // Show test case generation section with smooth transition
                const testCaseSection = document.getElementById('testCaseSection');
                testCaseSection.style.maxHeight = '2000px'; // Large enough for content
                testCaseSection.style.padding = '1.5rem';
                testCaseSection.style.marginBottom = '2rem';
                setTimeout(() => {
                    testCaseSection.style.opacity = '1';
                }, 10);
                
                results.classList.add('show');
                
            } catch (err) {
                console.error('Upload error:', err);
                const errorDiv = document.getElementById('error');
                
                // Format the error message, preserving line breaks
                let errorContent = err.message;
                
                // Replace newlines with <br> and format the message
                errorContent = errorContent
                    .split('\n')
                    .map(line => line.trim())
                    .filter(line => line.length > 0)
                    .join('<br>');
                
                // Add emphasis to missing columns if present
                errorContent = errorContent.replace(/missing required columns: (.*?)(Available|Found)/gi, (match, cols, next) => {
                    return `<strong>‚ùå Missing required columns: <code>${cols.trim()}</code></strong><br>${next}`;
                });
                
                // Add heading for found columns
                errorContent = errorContent.replace(/Found columns:/gi, '<strong style="margin-top: 0.5rem; display: block;">üìä Found columns:</strong>');
                
                errorDiv.innerHTML = errorContent;
                errorDiv.classList.add('show');
            } finally {
                loading.classList.remove('show');
                submitBtn.disabled = false;
            }
        });
        
        function displaySummary(summary) {
            const summaryDiv = document.getElementById('summary');
            let html = `
                <h3>üìä Mapping Summary</h3>
                <div class="summary-item">
                    <strong>Total Mappings:</strong> <span style="color: #2c5aa0; font-weight: 600;">${summary.total_mappings}</span>
                </div>`;
            
            // Display detected source tables
            if (summary.detected_source_tables && summary.detected_source_tables.length > 0) {
                html += `
                <div class="summary-item">
                    <strong>Detected Source Tables:</strong> <span style="color: #5a6c7d;">${summary.detected_source_tables.join(', ')}</span>
                </div>`;
            }
            
            html += `
                <div class="summary-item">
                    <strong>Source Columns:</strong> <span style="font-weight: 500;">${summary.source_columns.length}</span> (${summary.source_columns.join(', ')})
                </div>
                <div class="summary-item">
                    <strong>Target Columns:</strong> <span style="font-weight: 500;">${summary.target_columns.length}</span> (${summary.target_columns.join(', ')})
                </div>
            `;
            
            summaryDiv.innerHTML = html;
        }
        
        function displayAIAnalysis(aiAnalysis) {
            const aiDiv = document.getElementById('aiAnalysis');
            if (!aiAnalysis.ai_available) {
                aiDiv.style.display = 'none';
                return;
            }
            
            let html = '<div class="ai-analysis">';
            html += '<h3>ü§ñ AI Analysis & Recommendations</h3>';
            
            if (aiAnalysis.optimization_notes) {
                Object.keys(aiAnalysis.optimization_notes).forEach(queryType => {
                    const notes = aiAnalysis.optimization_notes[queryType];
                    if (notes.suggestions && notes.suggestions.length > 0) {
                        html += '<div style="margin: 1rem 0;"><strong style="color: #2c5aa0;">' + queryType.replace(/_/g, ' ').toUpperCase() + ':</strong><ul class="feature-list" style="margin-top: 0.5rem;">';
                        notes.suggestions.forEach(s => {
                            html += '<li style="padding: 0.25rem 0;">' + s + '</li>';
                        });
                        html += '</ul></div>';
                    }
                });
            }
            
            html += '</div>';
            aiDiv.innerHTML = html;
            aiDiv.style.display = 'block';
        }
        
        function displayQueries(queries) {
            const queriesDiv = document.getElementById('queries');
            queriesDiv.innerHTML = '';
            
            Object.keys(queries).forEach(key => {
                const title = key.split('_').map(w => w.charAt(0).toUpperCase() + w.slice(1)).join(' ');
                const querySection = document.createElement('div');
                querySection.className = 'query-section';
                querySection.innerHTML = '<div class="query-header"><h3>' + title + '</h3><button class="copy-btn" onclick="copyQuery(this)">üìã Copy</button></div><div class="query-box">' + escapeHtml(queries[key]) + '</div>';
                queriesDiv.appendChild(querySection);
            });
        }
        
        // AI Modal Functions
        function showAISuggestion() {
            document.getElementById('aiModal').style.display = 'block';
        }
        
        function closeAIModal() {
            document.getElementById('aiModal').style.display = 'none';
            document.getElementById('aiSuggestionResult').innerHTML = '';
        }
        
        function showFormatGuide() {
            document.getElementById('formatGuideModal').style.display = 'block';
        }
        
        function closeFormatGuide() {
            document.getElementById('formatGuideModal').style.display = 'none';
        }
        
        function showContactModal() {
            document.getElementById('contactModal').classList.add('show');
        }
        
        function closeContactModal() {
            document.getElementById('contactModal').classList.remove('show');
        }
        
        // Close contact modal when clicking outside
        document.addEventListener('DOMContentLoaded', function() {
            const contactModal = document.getElementById('contactModal');
            if (contactModal) {
                contactModal.addEventListener('click', function(e) {
                    if (e.target === contactModal) {
                        closeContactModal();
                    }
                });
            }
        });
        
        async function getAISuggestion() {
            const sourceCol = document.getElementById('aiSourceCol').value;
            const targetCol = document.getElementById('aiTargetCol').value;
            const sourceType = document.getElementById('aiSourceType').value;
            const targetType = document.getElementById('aiTargetType').value;
            
            if (!sourceCol || !targetCol) {
                alert('Please enter source and target column names');
                return;
            }
            
            const resultDiv = document.getElementById('aiSuggestionResult');
            resultDiv.innerHTML = '<div class="loading show"><div class="spinner"></div><p>Getting AI suggestion...</p></div>';
            
            try {
                const response = await fetch('/ai/suggest-transformation', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        source_column: sourceCol,
                        target_column: targetCol,
                        source_type: sourceType,
                        target_type: targetType
                    })
                });
                
                const data = await response.json();
                
                if (data.error) {
                    throw new Error(data.error);
                }
                
                let html = '<div style="background: #f5f5f5; padding: 1rem; border-radius: 6px;">';
                html += '<h4 style="color: #1a3a52; margin-bottom: 1rem;">Suggested Transformation:</h4>';
                html += '<pre style="background: #1e1e1e; color: #d4d4d4; padding: 1rem; border-radius: 4px; overflow-x: auto; font-size: 0.85em; line-height: 1.6;">' + escapeHtml(data.transformation) + '</pre>';
                html += '<p style="margin-top: 1rem;"><strong style="color: #1a3a52;">Explanation:</strong> <span style="color: #5a6c7d;">' + data.explanation + '</span></p>';
                html += '<p style="margin-top: 0.5rem;"><strong style="color: #1a3a52;">Confidence:</strong> <span style="color: ' + (data.confidence === 'high' ? '#22c55e' : data.confidence === 'medium' ? '#f59e0b' : '#ef4444') + '; font-weight: 600;">' + data.confidence.toUpperCase() + '</span></p>';
                html += '</div>';
                
                resultDiv.innerHTML = html;
            } catch (err) {
                resultDiv.innerHTML = '<div class="error show">Error: ' + err.message + '</div>';
            }
        }
        
        function showNLMapping() {
            document.getElementById('nlModal').style.display = 'block';
        }
        
        function closeNLModal() {
            document.getElementById('nlModal').style.display = 'none';
            document.getElementById('nlMappingResult').innerHTML = '';
        }
        
        async function generateFromNL() {
            const description = document.getElementById('nlDescription').value;
            
            if (!description) {
                alert('Please enter a description');
                return;
            }
            
            const resultDiv = document.getElementById('nlMappingResult');
            resultDiv.innerHTML = '<div class="loading show"><div class="spinner"></div><p>Generating mapping...</p></div>';
            
            try {
                const response = await fetch('/ai/generate-from-description', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ description: description })
                });
                
                const data = await response.json();
                
                if (data.error) {
                    throw new Error(data.error);
                }
                
                let html = '<div style="background: #f5f5f5; padding: 1rem; border-radius: 6px;">';
                html += '<h4 style="color: #1a3a52; margin-bottom: 1rem;">Generated Mapping (' + data.mappings.length + ' rows):</h4>';
                html += '<div style="overflow-x: auto;"><table style="width: 100%; border-collapse: collapse; font-size: 0.9em;">';
                html += '<tr style="background: #2c5aa0; color: white;"><th style="padding: 0.75rem; border: 1px solid #d0d7e0; text-align: left;">Source</th><th style="padding: 0.75rem; border: 1px solid #d0d7e0; text-align: left;">Target</th><th style="padding: 0.75rem; border: 1px solid #d0d7e0; text-align: left;">Transformation</th><th style="padding: 0.75rem; border: 1px solid #d0d7e0; text-align: left;">Key</th></tr>';
                
                data.mappings.forEach((m, idx) => {
                    const bg = idx % 2 === 0 ? 'white' : '#f8f9fa';
                    html += '<tr style="background: ' + bg + '; border: 1px solid #d0d7e0;">';
                    html += '<td style="padding: 0.75rem; border: 1px solid #d0d7e0; font-family: monospace; font-size: 0.85em; color: #5a6c7d;">' + (m.source_column || '') + '</td>';
                    html += '<td style="padding: 0.75rem; border: 1px solid #d0d7e0; font-family: monospace; font-size: 0.85em; color: #5a6c7d; font-weight: 500;">' + m.target_column + '</td>';
                    html += '<td style="padding: 0.75rem; border: 1px solid #d0d7e0; font-family: monospace; font-size: 0.85em; color: #2c5aa0;">' + m.transformation + '</td>';
                    html += '<td style="padding: 0.75rem; border: 1px solid #d0d7e0;">' + (m.is_key === 'Yes' || m.is_key === true ? '<span style="background: #e3eef9; color: #2c5aa0; padding: 0.25rem 0.5rem; border-radius: 3px; font-size: 0.85em;">Yes</span>' : '‚Äî') + '</td>';
                    html += '</tr>';
                });
                
                html += '</table></div>';
                html += '<p style="margin-top: 1rem; color: #5a6c7d; font-size: 0.9em;"><small>üí° Copy this table to create your CSV mapping file</small></p>';
                html += '</div>';
                
                resultDiv.innerHTML = html;
            } catch (err) {
                resultDiv.innerHTML = '<div class="error show">Error: ' + err.message + '</div>';
            }
        }
        
        function copyQuery(button) {
            const queryBox = button.parentElement.nextElementSibling;
            const text = queryBox.textContent;
            
            navigator.clipboard.writeText(text).then(() => {
                const originalText = button.textContent;
                button.textContent = '‚úì Copied!';
                setTimeout(() => {
                    button.textContent = originalText;
                }, 2000);
            });
        }
        
        // Test Case Generation Functions
        async function previewTestCases() {
            if (!window.currentMappingData) {
                alert('Please upload and process a mapping file first');
                return;
            }
            
            const testType = document.getElementById('testType').value;
            const previewDiv = document.getElementById('testCasePreview');
            const contentDiv = document.getElementById('testCasePreviewContent');
            
            contentDiv.innerHTML = '<div class="loading show"><div class="spinner"></div><p>Generating test cases...</p></div>';
            previewDiv.style.display = 'block';
            
            try {
                const response = await fetch('/preview-test-cases', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        mappings: window.currentMappingData.mappings,
                        summary: window.currentMappingData.summary,
                        test_type: testType
                    })
                });
                
                const data = await response.json();
                
                if (!response.ok || data.error) {
                    throw new Error(data.error || 'Failed to generate test cases');
                }
                
                // Display test case counts
                let html = '<div style="background: #f0f9ff; padding: 1rem; border-radius: 4px; margin-bottom: 1rem; border-left: 4px solid #00a2e8;">';
                html += '<div style="display: flex; justify-content: space-around; text-align: center;">';
                html += '<div><strong style="color: #22c55e; font-size: 1.5em;">' + data.positive_count + '</strong><br><span style="color: #5a6c7d; font-size: 0.9em;">Positive</span></div>';
                html += '<div><strong style="color: #ef4444; font-size: 1.5em;">' + data.negative_count + '</strong><br><span style="color: #5a6c7d; font-size: 0.9em;">Negative</span></div>';
                html += '<div><strong style="color: #2c5aa0; font-size: 1.5em;">' + data.total_count + '</strong><br><span style="color: #5a6c7d; font-size: 0.9em;">Total</span></div>';
                html += '</div></div>';
                
                // Display test cases
                if (data.test_cases && data.test_cases.length > 0) {
                    data.test_cases.forEach((tc, idx) => {
                        const isPositive = tc.category === 'Positive';
                        const bgColor = isPositive ? '#f0fdf4' : '#fef2f2';
                        const borderColor = isPositive ? '#22c55e' : '#ef4444';
                        const iconColor = isPositive ? '#22c55e' : '#ef4444';
                        
                        html += '<div style="background: ' + bgColor + '; border-left: 4px solid ' + borderColor + '; padding: 1rem; margin-bottom: 1rem; border-radius: 4px;">';
                        html += '<div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 0.75rem;">';
                        html += '<div><strong style="color: ' + iconColor + ';">' + (isPositive ? '‚úÖ' : '‚ùå') + ' ' + tc.test_id + '</strong>';
                        html += '<span style="margin-left: 0.5rem; background: ' + (isPositive ? '#dcfce7' : '#fee2e2') + '; color: ' + iconColor + '; padding: 0.25rem 0.5rem; border-radius: 3px; font-size: 0.8em; font-weight: 600;">' + tc.priority + '</span></div>';
                        html += '<span style="background: white; padding: 0.25rem 0.5rem; border-radius: 3px; font-size: 0.85em; color: #5a6c7d;">' + tc.type + '</span>';
                        html += '</div>';
                        html += '<h5 style="color: #1a3a52; margin-bottom: 0.5rem; font-size: 1em;">' + tc.name + '</h5>';
                        html += '<p style="color: #5a6c7d; font-size: 0.9em; margin-bottom: 0.75rem; line-height: 1.5;">' + tc.description + '</p>';
                        
                        if (tc.test_steps && tc.test_steps.length > 0) {
                            html += '<details style="margin-top: 0.75rem;"><summary style="cursor: pointer; color: #2c5aa0; font-weight: 500; font-size: 0.9em;">üìã Test Steps (' + tc.test_steps.length + ')</summary>';
                            html += '<ol style="margin: 0.5rem 0 0 1.5rem; color: #5a6c7d; font-size: 0.85em; line-height: 1.6;">';
                            tc.test_steps.forEach(step => {
                                html += '<li style="margin-bottom: 0.25rem;">' + step + '</li>';
                            });
                            html += '</ol></details>';
                        }
                        
                        html += '<div style="margin-top: 0.75rem; padding: 0.5rem; background: white; border-radius: 3px;"><strong style="color: #2c5aa0; font-size: 0.85em;">Expected Result:</strong><br><span style="color: #5a6c7d; font-size: 0.85em;">' + tc.expected_result + '</span></div>';
                        html += '</div>';
                    });
                } else {
                    html += '<p style="color: #5a6c7d; text-align: center; padding: 2rem;">No test cases generated</p>';
                }
                
                contentDiv.innerHTML = html;
                
            } catch (err) {
                console.error('Error previewing test cases:', err);
                contentDiv.innerHTML = '<div class="error show">Error: ' + err.message + '</div>';
            }
        }
        
        async function downloadTestCases() {
            if (!window.currentMappingData) {
                alert('Please upload and process a mapping file first');
                return;
            }
            
            const testType = document.getElementById('testType').value;
            const format = document.getElementById('testFormat').value;
            
            try {
                const response = await fetch('/generate-test-cases', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        mappings: window.currentMappingData.mappings,
                        summary: window.currentMappingData.summary,
                        test_type: testType,
                        format: format
                    })
                });
                
                if (!response.ok) {
                    const data = await response.json();
                    throw new Error(data.error || 'Failed to generate test cases');
                }
                
                // Handle JSON format differently
                if (format === 'json') {
                    const data = await response.json();
                    if (data.error) {
                        throw new Error(data.error);
                    }
                    
                    // Download JSON
                    const blob = new Blob([data.content], { type: 'application/json' });
                    const url = window.URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = data.filename;
                    document.body.appendChild(a);
                    a.click();
                    window.URL.revokeObjectURL(url);
                    document.body.removeChild(a);
                    
                    alert('‚úì Test cases downloaded successfully! (' + data.test_case_count + ' test cases)');
                } else {
                    // For CSV formats, response is already a file
                    const blob = await response.blob();
                    const url = window.URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = 'etl_test_cases_' + format + '_' + testType + '.csv';
                    document.body.appendChild(a);
                    a.click();
                    window.URL.revokeObjectURL(url);
                    document.body.removeChild(a);
                    
                    alert('‚úì Test cases downloaded successfully!');
                }
                
            } catch (err) {
                console.error('Error downloading test cases:', err);
                alert('Error: ' + err.message);
            }
        }
        
        function closeTestCasePreview() {
            document.getElementById('testCasePreview').style.display = 'none';
        }
        
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
    </script>
</body>
</html>
